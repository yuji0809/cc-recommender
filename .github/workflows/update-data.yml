name: Update Recommendations Database

on:
  # æ¯Žæ—¥ AM 9:00 JST (00:00 UTC) ã«å®Ÿè¡Œ
  schedule:
    - cron: "0 0 * * *"

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  update-database:
    name: Update Recommendations Database
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 2æ™‚é–“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆä¸¦åˆ—æ•°10ãªã‚‰ç´„60åˆ†ã§å®Œäº†äºˆå®šï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Fetch latest data
        timeout-minutes: 90 # ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‹ã‚¹ã‚­ãƒ£ãƒ³ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        run: pnpm run fetch-data
        env:
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³è¨­å®š
          # "true": ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé«˜é€Ÿã€ãƒ†ã‚¹ãƒˆç”¨ï¼‰
          # "false": å®Ÿè¡Œï¼ˆæŽ¨å¥¨ã€å·®åˆ†ã‚¹ã‚­ãƒ£ãƒ³ã§åŠ¹çŽ‡åŒ–æ¸ˆã¿ï¼‰
          SKIP_SECURITY_SCAN: "false"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/plugins.json data/mcp-servers.json data/skills.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(data): update recommendations database"
          title: "ðŸ”„ Update recommendations database"
          body: |
            ## ðŸ“Š Automated Database Update

            This PR updates the recommendations database with the latest data from:
            - Official Claude Code plugins
            - awesome-mcp-servers
            - awesome-claude-code

            ### Changes Summary
            - Updated `data/plugins.json`
            - Updated `data/mcp-servers.json`
            - Updated `data/skills.json`
            - Timestamp: ${{ github.event.repository.updated_at }}

            ### Review Checklist
            - [ ] Data looks correct
            - [ ] No sensitive information included
            - [ ] Security scores are reasonable

            ---
            ðŸ¤– Auto-generated by GitHub Actions
          branch: update-recommendations-data
          delete-branch: true
          labels: |
            automated
            data-update
